{% extends 'farm/base.html' %}
{% block title %}Milk Production ‚Äî Goat Farm Pro{% endblock %}
{% block page_title %}<span class='hi-only'>ü•õ ‡§¶‡•Ç‡§ß ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§®</span><span class='en-only'>ü•õ Milk Production</span>{% endblock %}
{% block page_breadcrumb %}<span class='hi-only'>‡§¶‡•Ç‡§ß</span><span class='en-only'>milk</span>{% endblock %}
{% block nav_milk %}active{% endblock %}

{% block page_sub %}<span class='hi-only'>‡§∏‡•Å‡§¨‡§π ‡§î‡§∞ ‡§∂‡§æ‡§Æ ‡§ï‡§æ ‡§¶‡•Ç‡§ß ‡§≤‡•â‡§ó</span><span class='en-only'>Morning & evening milk logs</span>{% endblock %}

{% block page_actions %}
<button class="btn btn-primary" onclick="document.getElementById('milkModal').classList.add('open')">+ <span class='hi-only'>‡§¶‡•Ç‡§ß ‡§≤‡•â‡§ó ‡§ï‡§∞‡•á‡§Ç</span><span class='en-only'>Log Milk</span></button>
{% endblock %}

{% block content %}

<div class="stats-grid" style="margin-bottom:22px;">
    <div class="stat-card green"><div class="stat-icon-wrap">ü•õ</div><div class="stat-value" id="sc-total">‚Äî</div><div class="stat-label"><span class="hi-only">‡§ï‡•Å‡§≤ ‡§≤‡•Ä‡§ü‡§∞</span><span class="en-only">Total Litres</span></div></div>
    <div class="stat-card blue"><div class="stat-icon-wrap">üåÖ</div><div class="stat-value" id="sc-morning">‚Äî</div><div class="stat-label"><span class="hi-only">‡§∏‡•Å‡§¨‡§π</span><span class="en-only">Morning</span></div></div>
    <div class="stat-card amber"><div class="stat-icon-wrap">üåÜ</div><div class="stat-value" id="sc-evening">‚Äî</div><div class="stat-label"><span class="hi-only">‡§∂‡§æ‡§Æ</span><span class="en-only">Evening</span></div></div>
    <div class="stat-card pink"><div class="stat-icon-wrap">üìÖ</div><div class="stat-value" id="sc-records">‚Äî</div><div class="stat-label"><span class="hi-only">‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°</span><span class="en-only">Records</span></div></div>
</div>

<div class="card" style="padding:0;">
    <div class="table-wrap">
        <table>
            <thead><tr><th><span class="hi-only">‡§¨‡§ï‡§∞‡•Ä</span><span class="en-only">Goat</span></th><th><span class="hi-only">‡§§‡§æ‡§∞‡•Ä‡§ñ</span><span class="en-only">Date</span></th><th><span class="hi-only">‡§∏‡§Æ‡§Ø</span><span class="en-only">Session</span></th><th><span class="hi-only">‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ (L)</span><span class="en-only">Quantity (L)</span></th><th><span class="hi-only">‡§´‡•à‡§ü %</span><span class="en-only">Fat %</span></th></tr></thead>
            <tbody id="milkBody"><tr><td colspan="5" style="padding:30px;text-align:center;"><div class="loading-dots" style="display:inline-flex;gap:6px;"><span></span><span></span><span></span></div></td></tr></tbody>
        </table>
    </div>
</div>

<div class="modal-overlay" id="milkModal">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">ü•õ Log Milk Production</div>
            <button class="modal-close" onclick="document.getElementById('milkModal').classList.remove('open')">‚úï</button>
        </div>
        <form onsubmit="submitMilk(event)">
            <div class="form-group"><label class="form-label">Goat ID *</label><input class="form-input" id="m-goat" type="number" required></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
                <div class="form-group"><label class="form-label">Date *</label><input class="form-input" type="date" id="m-date" required></div>
                <div class="form-group"><label class="form-label">Session *</label>
                    <select class="form-select" id="m-session">
                        <option value="M">üåÖ Morning</option><option value="E">üåÜ Evening</option>
                    </select>
                </div>
                <div class="form-group"><label class="form-label">Quantity (litres) *</label><input class="form-input" type="number" id="m-qty" step="0.1" min="0" required></div>
                <div class="form-group"><label class="form-label">Fat %</label><input class="form-input" type="number" id="m-fat" step="0.1" min="0" placeholder="Optional"></div>
            </div>
            <div style="display:flex;gap:10px;margin-top:14px;justify-content:flex-end;">
                <button type="button" class="btn btn-outline" onclick="document.getElementById('milkModal').classList.remove('open')">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
const API = window.location.origin + '/api';

function loadMilk() {
    fetch(API + '/milk/')
        .then(r => r.json())
        .then(data => {
            const total    = data.reduce((s, r) => s + r.quantity, 0);
            const morning  = data.filter(r => r.session === 'M').reduce((s, r) => s + r.quantity, 0);
            const evening  = data.filter(r => r.session === 'E').reduce((s, r) => s + r.quantity, 0);
            document.getElementById('sc-total').textContent   = total.toFixed(1) + 'L';
            document.getElementById('sc-morning').textContent = morning.toFixed(1) + 'L';
            document.getElementById('sc-evening').textContent = evening.toFixed(1) + 'L';
            document.getElementById('sc-records').textContent = data.length;
            const tbody = document.getElementById('milkBody');
            if (!data.length) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:30px;color:var(--text-dim);">No milk records yet</td></tr>';
                return;
            }
            tbody.innerHTML = data.map(r => `<tr>
                <td>üêê #${r.goat_id}</td>
                <td style="font-family:'JetBrains Mono',monospace;font-size:0.82rem;">${r.date}</td>
                <td><span class="badge ${r.session==='M'?'badge-amber':'badge-blue'}">${r.session==='M'?'üåÖ Morning':'üåÜ Evening'}</span></td>
                <td style="font-family:'JetBrains Mono',monospace;font-weight:700;color:var(--primary);">${r.quantity} L</td>
                <td>${r.fat_percentage ? r.fat_percentage + '%' : '‚Äî'}</td>
            </tr>`).join('');
        })
        .catch(() => { document.getElementById('milkBody').innerHTML = '<tr><td colspan="5" style="color:var(--danger);text-align:center;padding:20px;">Error loading</td></tr>'; });
}

async function submitMilk(e) {
    e.preventDefault();
    const payload = {
        goat_id: parseInt(document.getElementById('m-goat').value),
        date: document.getElementById('m-date').value,
        session: document.getElementById('m-session').value,
        quantity: parseFloat(document.getElementById('m-qty').value),
        fat_percentage: parseFloat(document.getElementById('m-fat').value) || null,
    };
    try {
        const res = await fetch(`${API}/milk/`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        if (!res.ok) throw new Error(await res.text());
        showToast('‚úÖ Milk record saved!');
        document.getElementById('milkModal').classList.remove('open');
        loadMilk();
    } catch (err) { showToast('‚ùå ' + err.message, 'error'); }
}

document.getElementById('milkModal').addEventListener('click', function(e) { if(e.target===this) this.classList.remove('open'); });
window.addEventListener('DOMContentLoaded', loadMilk);
{% endblock %}
